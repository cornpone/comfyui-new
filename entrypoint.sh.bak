#!/usr/bin/env bash
set -euo pipefail
COMFY_DIR="/workspace/ComfyUI"
if [ ! -f "$COMFY_DIR/main.py" ]; then
  mkdir -p "$COMFY_DIR"
  rsync -a --ignore-existing /home/app/ComfyUI/ "$COMFY_DIR"/ || true
fi
CS_AUTH="none"; [ -n "${PASSWORD:-}" ] && CS_AUTH="password"
code-server --bind-addr 0.0.0.0:8080 --auth "$CS_AUTH" /workspace &
/home/app/venv/bin/python -m pip install --upgrade --no-cache-dir pip setuptools wheel
/home/app/venv/bin/pip install --no-cache-dir --index-url https://download.pytorch.org/whl/cu128 \
  torch==2.8.0 torchvision==0.23.0 torchaudio==2.8.0
/home/app/venv/bin/pip install --no-cache-dir --prefer-binary -r "$COMFY_DIR/requirements.txt" || true
if [ -d "$COMFY_DIR/custom_nodes" ]; then
  /home/app/venv/bin/pip install --no-cache-dir uv gitpython || true
  find "$COMFY_DIR/custom_nodes" -maxdepth 2 -type f -name requirements.txt -print0 \
    | xargs -0 -I{} /home/app/venv/bin/pip install --no-cache-dir -r "{}" || true
fi
cd "$COMFY_DIR"
exec /home/app/venv/bin/python main.py --listen 0.0.0.0 --port 8188
